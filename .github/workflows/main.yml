name: CI/CD - Tests, Release, and Reports
on:
  push:
    branches: [ master, lab08 ]

permissions:
  contents: write
  id-token: write

jobs:
  UnitTests:
    name: Unit Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
      - name: Unit Tests
        run: mvn -B -Dtest=com.napier.devops.AppTest test

  IntegrationTests:
    name: Integration Tests
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build DB image
        run: docker build -t employees-db ./db

      - name: Start DB
        run: docker run -d --name employees -p 33060:3306 employees-db

      - name: Wait for DB to be healthy
        run: |
          for i in {1..60}; do
            if docker exec employees mysqladmin ping -pexample --silent; then
              echo "DB is up"; exit 0
            fi
            echo "Waiting for DB..."; sleep 2
          done
          echo "DB did not become healthy in time"; docker logs employees; exit 1

      - name: Integration Tests
        env:
          INT_DB_URL: "jdbc:mysql://localhost:33060/employees?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
          DB_USER: app
          DB_PASS: example
        run: mvn -B -Dtest=com.napier.devops.AppIntegrationTest test

      - name: Upload coverage to Codecov (optional)
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./target/site/jacoco/jacoco.xml
          flags: integration
          verbose: true

      - name: Stop DB
        if: always()
        run: |
          docker logs employees || true
          docker stop employees || true
          docker rm employees || true
          docker image rm employees-db || true

  build:
    name: Build, Run in Compose, Deploy Release, Publish Reports
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Package (skip tests)
        run: mvn -B -DskipTests package

      - name: Run docker compose (generate reports)
        run: docker compose up --abort-on-container-exit

      - name: Publish Release (attach ./target/*.jar)
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          prerelease: false
          automatic_release_tag: "latest"
          files: |
            ./target/*.jar

      - name: Find app container
        id: find_app
        run: |
          NAME=$(docker ps -a --format '{{.Names}}' | grep '_app_1$' || true)
          if [ -z "$NAME" ]; then
            echo "Could not find *_app_1 container. Listing containers:"
            docker ps -a
            exit 1
          fi
          echo "container_name=$NAME" >> $GITHUB_OUTPUT

      - name: Copy /app/reports to workspace
        run: |
          docker container cp "${{ steps.find_app.outputs.container_name }}":/app/reports ./reports
          ls -l ./reports || true

      - name: Deploy reports folder to reports branch
        uses: JamesIves/github-pages-deploy-action@v4.2.5
        with:
          branch: reports
          folder: reports
